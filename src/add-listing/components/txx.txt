import React, { useState, useImperativeHandle, forwardRef } from "react";
import { Cloudinary } from "@cloudinary/url-gen";
import { auto } from "@cloudinary/url-gen/actions/resize";
import { autoGravity } from "@cloudinary/url-gen/qualifiers/gravity";
import { AdvancedImage } from "@cloudinary/react";
import { db } from "../../../configs"; // Firestore config
import { collection, addDoc } from "firebase/firestore";

const UploadImages = forwardRef((_, ref) => {
  const [selectedFiles, setSelectedFiles] = useState([]);
  const [uploadProgress, setUploadProgress] = useState({});
  const [transformedImages, setTransformedImages] = useState([]);

  const cld = new Cloudinary({ cloud: { cloudName: "duutgarew" } });

  // Handle file selection
  const onFileSelected = (event) => {
    const files = Array.from(event.target.files);
    setSelectedFiles((prevFiles) => [...prevFiles, ...files]);
  };

  // Upload files to Cloudinary
  const uploadFiles = async () => {
    for (const file of selectedFiles) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "car-market"); // Replace with your preset

      try {
        const response = await fetch(
          "https://api.cloudinary.com/v1_1/duutgarew/image/upload",
          {
            method: "POST",
            body: formData,
          }
        );

        if (!response.ok) {
          throw new Error(
            `Cloudinary upload failed with status ${response.status}`
          );
        }

        const data = await response.json();
        console.log("Cloudinary response:", data);

        // Update progress
        setUploadProgress((prevProgress) => ({
          ...prevProgress,
          [file.name]: 100,
        }));

        // Save to Firestore
        await addImageUrlToFirestore({ url: data.secure_url });

        // Transform the uploaded image
        const transformedImg = cld
          .image(data.public_id)
          .format("auto")
          .quality("auto")
          .resize(auto().gravity(autoGravity()).width(500).height(500));

        setTransformedImages((prev) => [...prev, transformedImg]);
      } catch (error) {
        console.error("Error uploading to Cloudinary:", error);
      }
    }
  };

  // Save the image URL to Firestore
  const addImageUrlToFirestore = async (image) => {
    try {
      const docRef = await addDoc(collection(db, "car_images"), {
        url: image.url,
        timestamp: new Date(),
      });
      console.log("Document written with ID:", docRef.id);
    } catch (error) {
      console.error("Error adding document:", error);
    }
  };

  // Remove a file
  const removeFile = (index) => {
    setSelectedFiles((prevFiles) => prevFiles.filter((_, i) => i !== index));
  };

  useImperativeHandle(ref, () => ({
    uploadFiles,
  }));

  return (
    <div>
      <h2 className="font-medium text-xl my-3 text-gray-700">
        Upload Car Images
      </h2>
      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        {selectedFiles.map((file, index) => (
          <div key={index} className="relative group border rounded-xl">
            <img
              src={URL.createObjectURL(file)}
              alt={`Preview ${index}`}
              className="h-32 w-full object-cover"
            />
            <button
              onClick={() => removeFile(index)}
              className="absolute top-1 right-1 bg-red-600 text-white text-xs px-2 py-1 rounded-full"
            >
              âœ•
            </button>
            {uploadProgress[file.name] && (
              <div className="absolute bottom-0 left-0 right-0 bg-purple-500 text-white text-xs text-center">
                {uploadProgress[file.name]}%
              </div>
            )}
          </div>
        ))}

        <label htmlFor="upload-images" className="border-dotted border">
          <div className="p-10">Add Images</div>
        </label>
        <input
          type="file"
          multiple
          id="upload-images"
          className="hidden"
          onChange={onFileSelected}
        />
      </div>
    </div>
  );
});

export default UploadImages;



